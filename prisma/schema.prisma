// Prisma Schema for Snap-form
// Database: PostgreSQL

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================
// USER & AUTHENTICATION
// ============================================

enum Role {
  USER
  ADMIN
  SUPER_ADMIN
}

enum Plan {
  FREE
  PREMIUM
  BUSINESS
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  emailVerified DateTime?

  // Role & Subscription
  role          Role      @default(USER)
  plan          Plan      @default(FREE)

  // Relations
  forms         Form[]
  sessions      Session[]
  accounts      Account[]

  // Metadata
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
  @@index([role])
  @@map("users")
}

// BetterAuth Session Model
model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

// BetterAuth Account Model (OAuth)
model Account {
  id                String  @id @default(cuid())
  userId            String
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  type              String
  provider          String
  providerAccountId String

  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

// BetterAuth Verification Model
model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
  @@map("verifications")
}

// ============================================
// FORMS & RESPONSES
// ============================================

model Form {
  id           String   @id @default(cuid())
  title        String
  description  String?  @db.Text

  // Appearance
  coverUrl     String?
  iconSymbol   String?  @default("üìù")

  // Settings
  requireEmail Boolean  @default(true)
  published    Boolean  @default(false)
  slug         String?  @unique

  // Form structure stored as JSON
  // Array of Field objects: { id, type, label, required?, options? }
  fields       Json     @default("[]")

  // Google Sheets integration
  googleSheetId String?
  googleSheetUrl String?

  // Owner
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  responses    Response[]

  // Metadata
  viewCount    Int      @default(0)
  responseCount Int     @default(0)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([published])
  @@index([slug])
  @@index([createdAt])
  @@map("forms")
}

model Response {
  id        String   @id @default(cuid())

  // Related form
  formId    String
  form      Form     @relation(fields: [formId], references: [id], onDelete: Cascade)

  // Response data
  email     String?
  data      Json     @default("{}") // Field responses as key-value pairs { fieldId: value }

  // Metadata for analytics
  ipAddress String?
  userAgent String?
  referrer  String?

  createdAt DateTime @default(now())

  @@index([formId])
  @@index([createdAt])
  @@index([email])
  @@map("responses")
}

// ============================================
// TEMPLATES
// ============================================

model Template {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  category    String?

  // Template structure (same format as Form.fields)
  fields      Json     @default("[]")

  // Preview
  iconSymbol  String?  @default("üìã")

  // Metadata
  featured    Boolean  @default(false)
  useCount    Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([featured])
  @@index([category])
  @@map("templates")
}
